<UserControl x:Class="Farmacia.UI.Wpf.Views.PatientsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:Farmacia.UI.Wpf.Converters"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:models="clr-namespace:Farmacia.UI.Wpf.Models"
             mc:Ignorable="d"
             Loaded="UserControl_OnLoaded">
    <UserControl.Resources>
        <SolidColorBrush x:Key="PatientsAccentBrush" Color="#0EA5E9" />
        <SolidColorBrush x:Key="PatientsAccentAltBrush" Color="#0284C7" />
        <SolidColorBrush x:Key="PatientsAccentSoftBrush" Color="#38BDF8" />

    <converters:DateOnlyToDateTimeConverter x:Key="DateOnlyConverter" />

        <LinearGradientBrush x:Key="PatientsHeroBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#E0F2FE" Offset="0" />
            <GradientStop Color="#FFFFFF" Offset="1" />
        </LinearGradientBrush>

        <Style x:Key="PatientsLabelStyle" TargetType="TextBlock" BasedOn="{StaticResource CaptionStyle}">
            <Setter Property="Foreground" Value="{StaticResource NeutralDarkBrush}" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Margin" Value="0,14,0,4" />
        </Style>

        <Style x:Key="PatientsTextBoxStyle" TargetType="TextBox">
            <Setter Property="FontSize" Value="14" />
            <Setter Property="Padding" Value="14,10" />
            <Setter Property="Background" Value="{StaticResource SurfaceAltBrush}" />
            <Setter Property="Foreground" Value="{StaticResource NeutralDarkBrush}" />
            <Setter Property="BorderBrush" Value="{StaticResource SeparatorBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Margin" Value="0,6,0,0" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="12">
                            <ScrollViewer x:Name="PART_ContentHost" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PatientsBadgeStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="16" />
            <Setter Property="Padding" Value="10,6" />
            <Setter Property="Background" Value="#E0F2FE" />
            <Setter Property="BorderBrush" Value="{StaticResource PatientsAccentBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Margin" Value="0,0,12,12" />
        </Style>

        <Style x:Key="PatientsMetricCardStyle" TargetType="Border" BasedOn="{StaticResource CardStyle}">
            <Setter Property="Padding" Value="24" />
            <Setter Property="CornerRadius" Value="24" />
            <Setter Property="Background" Value="#FFFFFF" />
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="#1A1C33" BlurRadius="22" ShadowDepth="8" Opacity="0.08" />
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PatientsMetricLabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Foreground" Value="#4B5563" />
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>

        <Style x:Key="PatientsMetricValueStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="30" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="Foreground" Value="{StaticResource NeutralDarkBrush}" />
            <Setter Property="Margin" Value="0,8,0,4" />
        </Style>

        <Style x:Key="PatientsCatalogItemStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="0" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="VerticalContentAlignment" Value="Stretch" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="FocusVisualStyle" Value="{x:Null}" />
        </Style>

        <Style x:Key="PatientsCatalogCardStyle" TargetType="Border" BasedOn="{StaticResource CardStyle}">
            <Setter Property="CornerRadius" Value="20" />
            <Setter Property="Padding" Value="20" />
            <Setter Property="Margin" Value="0,0,18,18" />
            <Setter Property="Background" Value="#FFFFFF" />
            <Setter Property="BorderBrush" Value="#E2E8F0" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Width" Value="320" />
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="#1A1C33" BlurRadius="18" ShadowDepth="8" Opacity="0.08" />
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PatientsStatusBadgeStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="14" />
            <Setter Property="Padding" Value="6,4" />
            <Setter Property="Margin" Value="0,6,6,0" />
            <Setter Property="Background" Value="#F8FAFC" />
            <Setter Property="BorderBrush" Value="{StaticResource SeparatorBrush}" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>

        <Style x:Key="PatientsInfoBadgeStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="16" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="Margin" Value="0,0,8,0" />
            <Setter Property="Background" Value="#F8FAFC" />
            <Setter Property="BorderBrush" Value="{StaticResource SeparatorBrush}" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>
    </UserControl.Resources>
    <Grid Background="Transparent">
        <ScrollViewer VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <StackPanel Margin="24,16,24,40">
                <Border Background="{StaticResource PatientsHeroBrush}"
                        CornerRadius="30"
                        Padding="32"
                        Margin="0,0,0,28">
                    <Border.Effect>
                        <DropShadowEffect Color="#1A1C33" BlurRadius="26" ShadowDepth="10" Opacity="0.08" />
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="1.6*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel>
                            <TextBlock Text="Pacientes"
                                       FontSize="28"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource NeutralDarkBrush}" />
                            <TextBlock Text="Centraliza expedientes, identifica prioridades y mantén la atención continua." 
                                       Style="{StaticResource CaptionStyle}"
                                       Margin="0,12,0,20"
                                       TextWrapping="Wrap" />
                            <WrapPanel Margin="0,0,0,20">
                                <Border Style="{StaticResource PatientsBadgeStyle}">
                                    <TextBlock Text="{Binding TotalPatients, StringFormat='Activos {0}'}"
                                               FontWeight="SemiBold"
                                               Foreground="{StaticResource PatientsAccentAltBrush}" />
                                </Border>
                                <Border Style="{StaticResource PatientsBadgeStyle}"
                                        Background="#ECFEFF"
                                        BorderBrush="Transparent"
                                        Margin="12,0,0,12">
                                    <TextBlock Text="{Binding UpcomingBirthdays, StringFormat='Cumpleaños {0}'}"
                                               FontWeight="SemiBold"
                                               Foreground="{StaticResource PatientsAccentBrush}" />
                                </Border>
                                <Border Style="{StaticResource PatientsBadgeStyle}"
                                        Background="#FFF1F2"
                                        BorderBrush="Transparent"
                                        Margin="12,0,0,12">
                                    <TextBlock Text="{Binding WithoutContactInfo, StringFormat='Sin contacto {0}'}"
                                               FontWeight="SemiBold"
                                               Foreground="{StaticResource DangerBrush}" />
                                </Border>
                            </WrapPanel>
                            <StackPanel Orientation="Horizontal">
                                <Button Content="Actualizar directorio"
                                        Command="{Binding LoadCommand}"
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Height="42"
                                        MinWidth="170" />
                                <Button Content="Buscar"
                                        Command="{Binding SearchCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Height="42"
                                        Margin="12,0,0,0"
                                        MinWidth="140" />
                            </StackPanel>
                        </StackPanel>

                        <Border Grid.Column="1"
                                Background="#FFFFFF"
                                CornerRadius="24"
                                Padding="24"
                                Margin="28,0,0,0">
                            <Border.Effect>
                                <DropShadowEffect Color="#1A1C33" BlurRadius="20" ShadowDepth="8" Opacity="0.06" />
                            </Border.Effect>
                            <StackPanel>
                                <TextBlock Text="Resumen de seguimiento"
                                           FontSize="16"
                                           FontWeight="SemiBold"
                                           Foreground="{StaticResource NeutralDarkBrush}" />
                                <Separator Margin="0,12,0,18" />
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <Ellipse Width="10" Height="10" Fill="{StaticResource PatientsAccentBrush}" VerticalAlignment="Center" />
                                    <TextBlock Text="Consultas recientes" Margin="8,0,0,0" Foreground="#6B7280" />
                                    <TextBlock Text="{Binding RecentConsultations}"
                                               FontWeight="SemiBold"
                                               Margin="16,0,0,0"
                                               Foreground="{StaticResource PatientsAccentAltBrush}" />
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <Ellipse Width="10" Height="10" Fill="{StaticResource WarningBrush}" VerticalAlignment="Center" />
                                    <TextBlock Text="Cumpleaños próximos" Margin="8,0,0,0" Foreground="#6B7280" />
                                    <TextBlock Text="{Binding UpcomingBirthdays}"
                                               FontWeight="SemiBold"
                                               Margin="16,0,0,0"
                                               Foreground="{StaticResource WarningBrush}" />
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <Ellipse Width="10" Height="10" Fill="{StaticResource DangerBrush}" VerticalAlignment="Center" />
                                    <TextBlock Text="Datos pendientes" Margin="8,0,0,0" Foreground="#6B7280" />
                                    <TextBlock Text="{Binding WithoutContactInfo, StringFormat='Sin contacto {0}'}"
                                               FontWeight="SemiBold"
                                               Margin="16,0,0,0"
                                               Foreground="{StaticResource DangerBrush}" />
                                </StackPanel>
                                <ProgressBar Margin="0,22,0,0"
                                             Height="6"
                                             Minimum="0"
                                             Maximum="1"
                                             IsIndeterminate="True"
                                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>

                <Grid Margin="0,0,0,28">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <Border Grid.Column="0"
                            Style="{StaticResource PatientsMetricCardStyle}"
                            Margin="0,0,18,0">
                        <StackPanel>
                            <TextBlock Text="Pacientes activos" Style="{StaticResource PatientsMetricLabelStyle}" />
                            <TextBlock Text="{Binding TotalPatients}" Style="{StaticResource PatientsMetricValueStyle}" />
                            <TextBlock Text="Directorio actualizado" Style="{StaticResource CaptionStyle}" />
                        </StackPanel>
                    </Border>

                    <Border Grid.Column="1"
                            Style="{StaticResource PatientsMetricCardStyle}"
                            Background="#ECFEFF"
                            Margin="0,0,18,0">
                        <StackPanel>
                            <TextBlock Text="Cumpleaños próximos"
                                       Style="{StaticResource PatientsMetricLabelStyle}"
                                       Foreground="{StaticResource PatientsAccentBrush}" />
                            <TextBlock Text="{Binding UpcomingBirthdays}"
                                       Style="{StaticResource PatientsMetricValueStyle}"
                                       Foreground="{StaticResource PatientsAccentAltBrush}" />
                            <TextBlock Text="Planea felicitaciones" Style="{StaticResource CaptionStyle}" />
                        </StackPanel>
                    </Border>

                    <Border Grid.Column="2"
                            Style="{StaticResource PatientsMetricCardStyle}"
                            Background="#ECFDF5"
                            Margin="0,0,18,0">
                        <StackPanel>
                            <TextBlock Text="Consultas recientes"
                                       Style="{StaticResource PatientsMetricLabelStyle}"
                                       Foreground="{StaticResource SuccessBrush}" />
                            <TextBlock Text="{Binding RecentConsultations}"
                                       Style="{StaticResource PatientsMetricValueStyle}"
                                       Foreground="{StaticResource SuccessBrush}" />
                            <TextBlock Text="Seguimiento en curso" Style="{StaticResource CaptionStyle}" />
                        </StackPanel>
                    </Border>

                    <Border Grid.Column="3"
                            Style="{StaticResource PatientsMetricCardStyle}"
                            Background="#FFF1F2">
                        <StackPanel>
                            <TextBlock Text="Sin contacto"
                                       Style="{StaticResource PatientsMetricLabelStyle}"
                                       Foreground="{StaticResource DangerBrush}" />
                            <TextBlock Text="{Binding WithoutContactInfo}"
                                       Style="{StaticResource PatientsMetricValueStyle}"
                                       Foreground="{StaticResource DangerBrush}" />
                            <TextBlock Text="Actualiza teléfonos" Style="{StaticResource CaptionStyle}" />
                        </StackPanel>
                    </Border>
                </Grid>

                <Grid Margin="0,0,0,28">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="1.6*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <Border Grid.Column="0"
                            Background="#FFFFFF"
                            CornerRadius="26"
                            Padding="28"
                            BorderBrush="{StaticResource SeparatorBrush}"
                            BorderThickness="1"
                            Margin="0,0,22,0">
                        <StackPanel>
                            <TextBlock Text="Búsqueda inteligente"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource NeutralDarkBrush}" />
                            <TextBlock Text="Encuentra pacientes por nombre o teléfono y refresca el directorio."
                                       Style="{StaticResource CaptionStyle}"
                                       Margin="0,6,0,20"
                                       TextWrapping="Wrap" />

                            <TextBlock Text="Nombre o teléfono" Style="{StaticResource PatientsLabelStyle}" />
                            <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource PatientsTextBoxStyle}" />

                            <StackPanel Orientation="Horizontal" Margin="0,24,0,0" VerticalAlignment="Center">
                                <Button Content="Buscar"
                                        Command="{Binding SearchCommand}"
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Height="40"
                                        MinWidth="140" />
                                <Button Content="Mostrar todo"
                                        Command="{Binding LoadCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Height="40"
                                        Margin="12,0,0,0"
                                        MinWidth="150" />
                                <ProgressBar Width="120"
                                             Height="6"
                                             Margin="20,0,0,0"
                                             Minimum="0"
                                             Maximum="1"
                                             IsIndeterminate="True"
                                             VerticalAlignment="Center"
                                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            </StackPanel>

                            <TextBlock Text="{Binding StatusMessage}"
                                       Foreground="{StaticResource DangerBrush}"
                                       TextWrapping="Wrap"
                                       Margin="0,18,0,0">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Visible" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding StatusMessage}" Value="">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding StatusMessage}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                            <StackPanel Margin="0,28,0,0">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsDetailVisible}" Value="True">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>

                                <Separator Margin="0,0,0,18" />
                                <TextBlock Text="Ficha rápida"
                                           FontSize="18"
                                           FontWeight="SemiBold"
                                           Foreground="{StaticResource NeutralDarkBrush}" />
                                <TextBlock Text="Consulta datos clave y prepara el siguiente contacto."
                                           Style="{StaticResource CaptionStyle}"
                                           Margin="0,4,0,16"
                                           TextWrapping="Wrap" />

                                <Border Background="#F8FAFF"
                                        CornerRadius="18"
                                        Padding="18"
                                        BorderBrush="{StaticResource SeparatorBrush}"
                                        BorderThickness="1">
                                    <Border.DataContext>
                                        <Binding Path="SelectedPatient" />
                                    </Border.DataContext>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Name}"
                                                   FontSize="20"
                                                   FontWeight="Bold"
                                                   Foreground="{StaticResource NeutralDarkBrush}" />
                                        <TextBlock Text="{Binding Age, StringFormat='Edad {0}', TargetNullValue='Edad N/D'}"
                                                   Style="{StaticResource CaptionStyle}"
                                                   Margin="0,6,0,0" />
                                        <WrapPanel Margin="0,12,0,0">
                                            <Border Style="{StaticResource PatientsInfoBadgeStyle}">
                                                <TextBlock Text="{Binding Phone, TargetNullValue='Sin teléfono registrado'}" />
                                            </Border>
                                            <Border Style="{StaticResource PatientsInfoBadgeStyle}">
                                                <TextBlock Text="{Binding BirthDate, StringFormat='Nacimiento {0:dd MMM yyyy}', TargetNullValue='Nacimiento N/D'}" />
                                            </Border>
                                        </WrapPanel>
                                    </StackPanel>
                                </Border>

                                <Grid Margin="0,18,0,0">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="140" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Row="0"
                                               Grid.Column="0"
                                               Text="Teléfono"
                                               Style="{StaticResource CaptionStyle}" />
                                    <TextBlock Grid.Row="0"
                                               Grid.Column="1"
                                               Text="{Binding SelectedPatient.Phone, TargetNullValue='Sin teléfono registrado'}"
                                               TextWrapping="Wrap" />

                                    <TextBlock Grid.Row="1"
                                               Grid.Column="0"
                                               Text="Edad"
                                               Style="{StaticResource CaptionStyle}"
                                               Margin="0,12,0,0" />
                                    <TextBlock Grid.Row="1"
                                               Grid.Column="1"
                                               Text="{Binding SelectedPatient.Age, TargetNullValue='N/D'}"
                                               FontWeight="SemiBold"
                                               Margin="0,12,0,0" />

                                    <TextBlock Grid.Row="2"
                                               Grid.Column="0"
                                               Text="Nacimiento"
                                               Style="{StaticResource CaptionStyle}"
                                               Margin="0,12,0,0" />
                                    <TextBlock Grid.Row="2"
                                               Grid.Column="1"
                                               Text="{Binding SelectedPatient.BirthDate, StringFormat='{}{0:dd MMM yyyy}', TargetNullValue='Sin registro'}"
                                               Margin="0,12,0,0" />

                                    <TextBlock Grid.Row="3"
                                               Grid.Column="0"
                                               Text="Última consulta"
                                               Style="{StaticResource CaptionStyle}"
                                               Margin="0,12,0,0" />
                                    <TextBlock Grid.Row="3"
                                               Grid.Column="1"
                                               Text="{Binding SelectedPatient.LastConsultation, StringFormat='{}{0:dd MMM yyyy}', TargetNullValue='Sin consultas'}"
                                               Margin="0,12,0,0" />
                                </Grid>

                                <Border Margin="0,20,0,0">
                                    <Border.Style>
                                        <Style TargetType="Border" BasedOn="{StaticResource PatientsInfoBadgeStyle}">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Setter Property="Background" Value="#FEF3C7" />
                                            <Setter Property="BorderBrush" Value="{StaticResource WarningBrush}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedPatient.IsBirthdaySoon}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="Cumpleaños cercano: envía un recordatorio"
                                               Foreground="{StaticResource WarningBrush}"
                                               FontWeight="SemiBold" />
                                </Border>

                                <StackPanel Margin="0,24,0,0">
                                    <TextBlock Text="Notas"
                                               Style="{StaticResource PatientsLabelStyle}" />
                                    <Border Background="{StaticResource SurfaceAltBrush}"
                                            BorderBrush="{StaticResource SeparatorBrush}"
                                            BorderThickness="1"
                                            CornerRadius="16"
                                            Padding="16"
                                            Margin="0,10,0,0">
                                        <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="180">
                                            <TextBlock Text="{Binding SelectedPatient.Notes, TargetNullValue='Sin notas registradas'}"
                                                       TextWrapping="Wrap"
                                                       Foreground="{StaticResource NeutralDarkBrush}" />
                                        </ScrollViewer>
                                    </Border>
                                </StackPanel>

                                <StackPanel Orientation="Horizontal" Margin="0,24,0,0">
                                    <Button Content="Eliminar paciente"
                                            Command="{Binding DeletePatientCommand}"
                                            Style="{StaticResource DangerButtonStyle}"
                                            Height="40"
                                            MinWidth="170"
                                            ToolTip="Elimina el paciente seleccionado si no tiene citas pendientes ni consultas"
                                            IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />
                                    <Button Content="Actualizar directorio"
                                            Command="{Binding LoadCommand}"
                                            Style="{StaticResource SecondaryButtonStyle}"
                                            Height="40"
                                            Margin="12,0,0,0"
                                            MinWidth="170"
                                            IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />
                                </StackPanel>
                            </StackPanel>

                            <TextBlock Text="Busca un paciente y selecciónalo para ver su ficha."
                                       Foreground="#6B7280"
                                       TextWrapping="Wrap"
                                       Margin="0,28,0,0">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Visible" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsDetailVisible}" Value="True">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>
                    </Border>

                    <Border Grid.Column="1"
                            Background="#FFFFFF"
                            CornerRadius="26"
                            Padding="28"
                            BorderBrush="{StaticResource SeparatorBrush}"
                            BorderThickness="1">
                        <StackPanel>
                            <TextBlock Text="Prioriza acciones"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource NeutralDarkBrush}" />
                            <TextBlock Text="Detecta pacientes que necesitan contacto y prepara recordatorios oportunos."
                                       Style="{StaticResource CaptionStyle}"
                                       Margin="0,6,0,18"
                                       TextWrapping="Wrap" />
                            <Border Background="#ECFEFF"
                                    CornerRadius="18"
                                    Padding="18"
                                    Margin="0,0,0,12">
                                <StackPanel>
                                    <TextBlock Text="Cumpleaños en los próximos 30 días"
                                               Style="{StaticResource CaptionStyle}" />
                                    <TextBlock Text="{Binding UpcomingBirthdays}"
                                               FontSize="24"
                                               FontWeight="Bold"
                                               Foreground="{StaticResource PatientsAccentBrush}"
                                               Margin="0,6,0,0" />
                                    <TextBlock Text="Prepara mensajes personalizados y agendalos en tu CRM."
                                               Style="{StaticResource CaptionStyle}" />
                                </StackPanel>
                            </Border>
                            <Border Background="#FFF1F2"
                                    CornerRadius="18"
                                    Padding="18">
                                <StackPanel>
                                    <TextBlock Text="Pacientes sin teléfono registrado"
                                               Style="{StaticResource CaptionStyle}" />
                                    <TextBlock Text="{Binding WithoutContactInfo}"
                                               FontSize="24"
                                               FontWeight="Bold"
                                               Foreground="{StaticResource DangerBrush}"
                                               Margin="0,6,0,0" />
                                    <TextBlock Text="Solicita datos en la próxima visita para mantener contacto activo."
                                               Style="{StaticResource CaptionStyle}" />
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Border>
                </Grid>

                <Border Background="#FFFFFF"
                        CornerRadius="26"
                        Padding="28"
                        BorderBrush="{StaticResource SeparatorBrush}"
                        BorderThickness="1"
                        Margin="0,0,0,28">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="1.6*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Registrar nuevo paciente"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource NeutralDarkBrush}" />
                            <TextBlock Text="Captura los datos esenciales para dar seguimiento inmediato y actualizar el directorio."
                                       Style="{StaticResource CaptionStyle}"
                                       Margin="0,6,0,18"
                                       TextWrapping="Wrap" />

                            <Grid Margin="0,0,0,20">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2">
                                    <TextBlock Text="Nombre completo" Style="{StaticResource PatientsLabelStyle}" />
                                    <TextBox Text="{Binding NewPatientName, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource PatientsTextBoxStyle}"
                                             ToolTip="Nombre del paciente" />
                                </StackPanel>

                                <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,12,20,0">
                                    <TextBlock Text="Teléfono" Style="{StaticResource PatientsLabelStyle}" />
                                    <TextBox Text="{Binding NewPatientPhone, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource PatientsTextBoxStyle}"
                                             ToolTip="Teléfono de contacto" />
                                </StackPanel>

                                <StackPanel Grid.Row="1" Grid.Column="1" Margin="0,12,0,0">
                                    <TextBlock Text="Fecha de nacimiento" Style="{StaticResource PatientsLabelStyle}" />
                                    <DatePicker SelectedDate="{Binding NewPatientBirthDate, Mode=TwoWay, Converter={StaticResource DateOnlyConverter}}"
                                                Height="40"
                                                Margin="0,6,0,0"
                                                Padding="8,4"
                                                Background="{StaticResource SurfaceAltBrush}"
                                                BorderBrush="{StaticResource SeparatorBrush}"
                                                BorderThickness="1"
                                                DisplayDateStart="1900-01-01"
                                                ToolTip="Fecha de nacimiento" />
                                </StackPanel>

                                <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,12,20,0">
                                    <TextBlock Text="Datos generales" Style="{StaticResource PatientsLabelStyle}" />
                                    <TextBox Text="{Binding NewPatientGeneralData, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource PatientsTextBoxStyle}"
                                             AcceptsReturn="True"
                                             TextWrapping="Wrap"
                                             MinHeight="90"
                                             VerticalContentAlignment="Top"
                                             ToolTip="Notas generales o antecedentes" />
                                </StackPanel>

                                <StackPanel Grid.Row="2" Grid.Column="1" Margin="0,12,0,0">
                                    <TextBlock Text="Alergias" Style="{StaticResource PatientsLabelStyle}" />
                                    <TextBox Text="{Binding NewPatientAllergies, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource PatientsTextBoxStyle}"
                                             AcceptsReturn="True"
                                             TextWrapping="Wrap"
                                             MinHeight="90"
                                             VerticalContentAlignment="Top"
                                             ToolTip="Alergias conocidas" />
                                </StackPanel>

                                <StackPanel Grid.Row="3" Grid.Column="0" Margin="0,12,20,0">
                                    <TextBlock Text="Condiciones crónicas" Style="{StaticResource PatientsLabelStyle}" />
                                    <TextBox Text="{Binding NewPatientChronicConditions, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource PatientsTextBoxStyle}"
                                             AcceptsReturn="True"
                                             TextWrapping="Wrap"
                                             MinHeight="90"
                                             VerticalContentAlignment="Top"
                                             ToolTip="Condiciones a largo plazo" />
                                </StackPanel>

                                <StackPanel Grid.Row="3" Grid.Column="1" Margin="0,12,0,0">
                                    <TextBlock Text="Notas adicionales" Style="{StaticResource PatientsLabelStyle}" />
                                    <TextBox Text="{Binding NewPatientNotes, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource PatientsTextBoxStyle}"
                                             AcceptsReturn="True"
                                             TextWrapping="Wrap"
                                             MinHeight="90"
                                             VerticalContentAlignment="Top"
                                             ToolTip="Notas internas o recordatorios" />
                                </StackPanel>
                            </Grid>

                            <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                                <Button Content="Registrar paciente"
                                        Command="{Binding RegisterPatientCommand}"
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Height="42"
                                        MinWidth="170" />
                                <Button Content="Limpiar formulario"
                                        Command="{Binding ResetNewPatientFormCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Height="42"
                                        Margin="12,0,0,0"
                                        MinWidth="170" />
                                <ProgressBar Width="120"
                                             Height="6"
                                             Margin="20,0,0,0"
                                             Minimum="0"
                                             Maximum="1"
                                             IsIndeterminate="True"
                                             VerticalAlignment="Center"
                                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            </StackPanel>
                        </StackPanel>

                        <Border Grid.Column="1"
                                Background="#F8FAFF"
                                CornerRadius="22"
                                Padding="22"
                                Margin="24,0,0,0"
                                BorderBrush="{StaticResource SeparatorBrush}"
                                BorderThickness="1">
                            <StackPanel>
                                <TextBlock Text="Buenas prácticas"
                                           FontSize="16"
                                           FontWeight="SemiBold"
                                           Foreground="{StaticResource NeutralDarkBrush}" />
                                <TextBlock Text="Completa los datos críticos para habilitar recordatorios y seguimiento personalizado."
                                           Style="{StaticResource CaptionStyle}"
                                           Margin="0,8,0,18"
                                           TextWrapping="Wrap" />
                                <Border Background="#FFFFFF"
                                        CornerRadius="16"
                                        Padding="16"
                                        BorderBrush="{StaticResource SeparatorBrush}"
                                        BorderThickness="1"
                                        Margin="0,0,0,12">
                                    <StackPanel>
                                        <TextBlock Text="Asocia condiciones relevantes"
                                                   FontWeight="SemiBold"
                                                   Foreground="{StaticResource NeutralDarkBrush}" />
                                        <TextBlock Text="Las condiciones y alergias permiten preparar la consulta y evitar contraindicaciones."
                                                   Style="{StaticResource CaptionStyle}"
                                                   Margin="0,4,0,0"
                                                   TextWrapping="Wrap" />
                                    </StackPanel>
                                </Border>
                                <Border Background="#ECFEFF"
                                        CornerRadius="16"
                                        Padding="16"
                                        BorderBrush="Transparent">
                                    <StackPanel>
                                        <TextBlock Text="Sincroniza con agenda"
                                                   FontWeight="SemiBold"
                                                   Foreground="{StaticResource PatientsAccentBrush}" />
                                        <TextBlock Text="Al registrar pacientes podrás agendar citas y vincular consultas inmediatamente."
                                                   Style="{StaticResource CaptionStyle}"
                                                   Margin="0,4,0,0"
                                                   TextWrapping="Wrap" />
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>

                <Border Background="#FFFFFF"
                        CornerRadius="28"
                        Padding="0"
                        BorderBrush="{StaticResource SeparatorBrush}"
                        BorderThickness="1"
                        Margin="0,0,0,24">
                    <Border.Effect>
                        <DropShadowEffect Color="#1A1C33" BlurRadius="20" ShadowDepth="8" Opacity="0.06" />
                    </Border.Effect>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0"
                                Background="#F8FAFF"
                                Padding="24"
                                CornerRadius="28,28,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <StackPanel>
                                    <TextBlock Text="Catálogo de pacientes"
                                               FontSize="18"
                                               FontWeight="SemiBold"
                                               Foreground="{StaticResource NeutralDarkBrush}" />
                                    <TextBlock Text="Ordena tu directorio y localiza expedientes clave."
                                               Style="{StaticResource CaptionStyle}" />
                                </StackPanel>
                                <TextBlock Grid.Column="1"
                                           Text="{Binding Patients.Count, StringFormat='{}{0} registros'}"
                                           FontWeight="SemiBold"
                                           Foreground="{StaticResource PatientsAccentBrush}"
                                           VerticalAlignment="Center" />
                            </Grid>
                        </Border>

                        <Grid Grid.Row="1">
                            <ListBox ItemsSource="{Binding Patients}"
                                     SelectedItem="{Binding SelectedPatient, Mode=TwoWay}"
                                     ItemContainerStyle="{StaticResource PatientsCatalogItemStyle}"
                                     BorderThickness="0"
                                     Background="Transparent"
                                     Margin="20,16,20,20"
                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel IsItemsHost="True" />
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                                <ListBox.ItemTemplate>
                                    <DataTemplate DataType="{x:Type models:PatientListItemModel}">
                                        <Border>
                                            <Border.Style>
                                                <Style TargetType="Border" BasedOn="{StaticResource PatientsCatalogCardStyle}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListBoxItem}, Path=IsSelected}" Value="True">
                                                            <Setter Property="BorderBrush" Value="{StaticResource PatientsAccentBrush}" />
                                                            <Setter Property="BorderThickness" Value="2" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>

                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                </Grid.RowDefinitions>

                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Text="{Binding Name}"
                                                               FontSize="16"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource NeutralDarkBrush}"
                                                               TextWrapping="Wrap" />
                                                    <Button Grid.Column="1"
                                                            Content="Eliminar"
                                                            Command="{Binding DataContext.DeletePatientCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                                                            CommandParameter="{Binding}"
                                                            Style="{StaticResource DangerButtonStyle}"
                                                            Padding="10,6"
                                                            Margin="12,0,0,0"
                                                            ToolTip="Elimina el paciente si no tiene citas activas ni consultas registradas"
                                                            Focusable="False"
                                                            IsEnabled="{Binding DataContext.IsBusy, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}, Converter={StaticResource InverseBoolConverter}}" />
                                                </Grid>

                                                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,10,0,0">
                                                    <TextBlock Text="{Binding Age, StringFormat='Edad {0}', TargetNullValue='Edad N/D'}"
                                                               Style="{StaticResource CaptionStyle}" />
                                                    <TextBlock Text=" · " Style="{StaticResource CaptionStyle}" />
                                                    <TextBlock Text="{Binding LastConsultation, StringFormat='Última {0:dd MMM yyyy}', TargetNullValue='Sin consultas'}"
                                                               Style="{StaticResource CaptionStyle}" />
                                                </StackPanel>

                                                <Grid Grid.Row="2" Margin="0,12,0,0">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <StackPanel>
                                                        <TextBlock Text="Teléfono" Style="{StaticResource CaptionStyle}" />
                                                        <TextBlock Text="{Binding Phone, TargetNullValue='Sin teléfono'}"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{StaticResource NeutralDarkBrush}" />
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="1">
                                                        <TextBlock Text="Nacimiento" Style="{StaticResource CaptionStyle}" />
                                                        <TextBlock Text="{Binding BirthDate, StringFormat='{}{0:dd MMM yyyy}', TargetNullValue='Sin registro'}"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{StaticResource NeutralDarkBrush}" />
                                                    </StackPanel>
                                                </Grid>

                                                <WrapPanel Grid.Row="3" Margin="0,12,0,0">
                                                    <Border>
                                                        <Border.Style>
                                                            <Style TargetType="Border" BasedOn="{StaticResource PatientsStatusBadgeStyle}">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding HasPhone}" Value="False">
                                                                        <Setter Property="Visibility" Value="Visible" />
                                                                        <Setter Property="Background" Value="#FFF1F2" />
                                                                        <Setter Property="BorderBrush" Value="{StaticResource DangerBrush}" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <TextBlock Text="Sin contacto"
                                                                   Foreground="{StaticResource DangerBrush}"
                                                                   FontWeight="SemiBold" />
                                                    </Border>

                                                    <Border Margin="6,0,0,0">
                                                        <Border.Style>
                                                            <Style TargetType="Border" BasedOn="{StaticResource PatientsStatusBadgeStyle}">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsBirthdaySoon}" Value="True">
                                                                        <Setter Property="Visibility" Value="Visible" />
                                                                        <Setter Property="Background" Value="#FEF3C7" />
                                                                        <Setter Property="BorderBrush" Value="{StaticResource WarningBrush}" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <TextBlock Text="Cumpleaños pronto"
                                                                   Foreground="{StaticResource WarningBrush}"
                                                                   FontWeight="SemiBold" />
                                                    </Border>
                                                </WrapPanel>

                                                <TextBlock Grid.Row="4"
                                                           Text="{Binding Notes, TargetNullValue='Sin notas registradas'}"
                                                           Foreground="#4B5563"
                                                           TextWrapping="Wrap"
                                                           Margin="0,12,0,0"
                                                           TextTrimming="CharacterEllipsis"
                                                           ToolTip="{Binding Notes}" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>

                            <TextBlock Text="No se encontraron pacientes con este criterio."
                                       Foreground="#6B7280"
                                       FontStyle="Italic"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Patients.Count}" Value="0">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsBusy}" Value="True">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                            <Border Background="#FFFFFFCC"
                                    Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Text="Actualizando directorio..."
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           FontWeight="SemiBold"
                                           Foreground="{StaticResource NeutralDarkBrush}" />
                            </Border>
                        </Grid>
                    </Grid>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
