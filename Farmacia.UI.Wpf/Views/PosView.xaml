<UserControl x:Class="Farmacia.UI.Wpf.Views.PosView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:enums="clr-namespace:Farmacia.Domain.Enums;assembly=Farmacia.Domain"
             xmlns:models="clr-namespace:Farmacia.UI.Wpf.Models"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             Loaded="UserControl_OnLoaded">
    <UserControl.Resources>
        <Style x:Key="PosLabelStyle" TargetType="TextBlock" BasedOn="{StaticResource CaptionStyle}">
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Foreground" Value="{StaticResource NeutralDarkBrush}" />
            <Setter Property="Margin" Value="0,0,0,4" />
        </Style>

        <Style x:Key="PosTextBoxStyle" TargetType="TextBox">
            <Setter Property="FontSize" Value="14" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="BorderBrush" Value="{StaticResource SeparatorBrush}" />
            <Setter Property="Background" Value="{StaticResource SurfaceAltBrush}" />
            <Setter Property="Foreground" Value="{StaticResource NeutralDarkBrush}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10">
                            <ScrollViewer x:Name="PART_ContentHost" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PosComboBoxStyle" TargetType="ComboBox">
            <Setter Property="FontSize" Value="14" />
            <Setter Property="Padding" Value="10,6" />
            <Setter Property="Background" Value="{StaticResource SurfaceAltBrush}" />
            <Setter Property="BorderBrush" Value="{StaticResource SeparatorBrush}" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>

        <Style x:Key="PosCartDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Height" Value="44" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="Foreground" Value="{StaticResource NeutralDarkBrush}" />
            <Setter Property="Margin" Value="0,2,0,0" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#E8EDFF" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <LinearGradientBrush x:Key="PosHeroBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#F4F6FF" Offset="0" />
            <GradientStop Color="#F9FBFF" Offset="1" />
        </LinearGradientBrush>
        <LinearGradientBrush x:Key="PosMetricBrushPrimary" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#F1F5FF" Offset="0" />
            <GradientStop Color="#E3ECFF" Offset="1" />
        </LinearGradientBrush>
        <LinearGradientBrush x:Key="PosMetricBrushCart" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#F2FBF6" Offset="0" />
            <GradientStop Color="#E7F7ED" Offset="1" />
        </LinearGradientBrush>
        <SolidColorBrush x:Key="PosAccentBrush" Color="#2563EB" />
        <SolidColorBrush x:Key="PosSuccessBrush" Color="#16A34A" />
        <SolidColorBrush x:Key="PosWarningBrush" Color="#EA580C" />

        <Style x:Key="PosMetricCardStyle" TargetType="Border" BasedOn="{StaticResource CardStyle}">
            <Setter Property="Padding" Value="24" />
            <Setter Property="Margin" Value="0,0,24,24" />
            <Setter Property="MinWidth" Value="220" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="#1A1C33" BlurRadius="22" ShadowDepth="8" Opacity="0.08" />
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PosMetricLabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Foreground" Value="#5B6576" />
            <Setter Property="TextOptions.TextFormattingMode" Value="Display" />
        </Style>

        <Style x:Key="PosMetricValueStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="28" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="Foreground" Value="{StaticResource NeutralDarkBrush}" />
            <Setter Property="Margin" Value="0,10,0,6" />
        </Style>

        <Style x:Key="PosDataGridHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Foreground" Value="#1F2937" />
            <Setter Property="Background" Value="#F5F7FB" />
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="BorderBrush" Value="{StaticResource SeparatorBrush}" />
            <Setter Property="BorderThickness" Value="0,0,0,1" />
        </Style>

        <LinearGradientBrush x:Key="PosCartHeaderBrush" StartPoint="0,0" EndPoint="1,0">
            <GradientStop Color="#F1F5FF" Offset="0" />
            <GradientStop Color="#E3ECFF" Offset="1" />
        </LinearGradientBrush>

        <Style x:Key="SuggestionSecondaryTextStyle" TargetType="TextBlock" BasedOn="{StaticResource CaptionStyle}">
            <Setter Property="Foreground" Value="#64748B" />
            <Setter Property="Margin" Value="0,2,0,0" />
            <Style.Triggers>
                <Trigger Property="Text" Value="">
                    <Setter Property="Visibility" Value="Collapsed" />
                </Trigger>
                <Trigger Property="Text" Value=" ">
                    <Setter Property="Visibility" Value="Collapsed" />
                </Trigger>
                <Trigger Property="Text" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Collapsed" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="SuggestionListBoxItemStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="0" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <EventSetter Event="MouseLeftButtonUp" Handler="SuggestionItem_OnClick" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#F1F5F9" />
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>
    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
        <Grid Margin="24,0,24,32">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="{StaticResource PosHeroBrush}" CornerRadius="28" Padding="32" Margin="0,0,0,16">
                <Border.Effect>
                    <DropShadowEffect Color="#1A1C33" BlurRadius="28" ShadowDepth="10" Opacity="0.08" />
                </Border.Effect>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2.3*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <StackPanel>
                        <TextBlock Text="Punto de venta" FontSize="26" FontWeight="SemiBold" Foreground="#1F2937" />
                        <TextBlock Text="Escanea, calcula y finaliza pagos en un flujo cuidadosamente optimizado." Style="{StaticResource CaptionStyle}" Margin="0,8,0,0" />
                    </StackPanel>
                    <StackPanel Grid.Column="1" HorizontalAlignment="Right">
                        <Border Background="#FFFFFF" CornerRadius="18" Padding="20,14" Opacity="0.9">
                            <StackPanel>
                                <TextBlock Text="Total actual" FontSize="12" FontWeight="SemiBold" Foreground="#64748B" />
                                <TextBlock Text="{Binding Total, StringFormat=C}" FontSize="22" FontWeight="Bold" Foreground="{StaticResource PosAccentBrush}" />
                            </StackPanel>
                        </Border>
                        <Border Background="#FFFFFF" CornerRadius="18" Padding="20,14" Margin="0,12,0,0" Opacity="0.9">
                            <StackPanel>
                                <TextBlock Text="Artículos" FontSize="12" FontWeight="SemiBold" Foreground="#64748B" />
                                <TextBlock Text="{Binding CartItems.Count}" FontSize="20" FontWeight="Bold" Foreground="{StaticResource PosWarningBrush}" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Grid>
            </Border>

            <WrapPanel Grid.Row="1" Margin="0,8,0,12" HorizontalAlignment="Stretch">
                <Border Style="{StaticResource PosMetricCardStyle}" Background="{StaticResource PosMetricBrushPrimary}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <StackPanel>
                            <TextBlock Text="Total actual" Style="{StaticResource PosMetricLabelStyle}" />
                            <TextBlock Text="{Binding Total, StringFormat=C}" Style="{StaticResource PosMetricValueStyle}" />
                            <TextBlock Text="Actualizado al instante" Style="{StaticResource CaptionStyle}" />
                        </StackPanel>
                        <Border Grid.Column="1" Width="48" Height="48" CornerRadius="24" Background="#FFFFFF" Opacity="0.85" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Viewbox Width="26" Height="26">
                                <Path Data="M2,22 L10,14 16,18 26,6" Stroke="{StaticResource PosAccentBrush}" StrokeThickness="2.2" StrokeStartLineCap="Round" StrokeEndLineCap="Round" StrokeLineJoin="Round" Fill="Transparent" />
                            </Viewbox>
                        </Border>
                    </Grid>
                </Border>

                <Border Style="{StaticResource PosMetricCardStyle}" Background="{StaticResource PosMetricBrushCart}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <StackPanel>
                            <TextBlock Text="Artículos en carrito" Style="{StaticResource PosMetricLabelStyle}" />
                            <TextBlock Text="{Binding CartItems.Count}" Style="{StaticResource PosMetricValueStyle}" />
                            <TextBlock Text="Listos para cobrar" Style="{StaticResource CaptionStyle}" />
                        </StackPanel>
                        <Border Grid.Column="1" Width="48" Height="48" CornerRadius="24" Background="#FFFFFF" Opacity="0.85" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Viewbox Width="24" Height="24">
                                <Path Data="M4,6 H24 V22 H4 Z M8,2 H20 V6" Stroke="{StaticResource PosSuccessBrush}" StrokeThickness="2.2" StrokeStartLineCap="Round" StrokeEndLineCap="Round" StrokeLineJoin="Round" Fill="Transparent" />
                            </Viewbox>
                        </Border>
                    </Grid>
                </Border>

            </WrapPanel>

            <Grid Grid.Row="2" Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2.2*" />
                    <ColumnDefinition Width="1*" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Margin="0,0,20,0">
                    <Border CornerRadius="26" Background="#FFFFFF" Padding="26" Margin="0,0,0,20">
                        <Border.Effect>
                            <DropShadowEffect Color="#1A1C33" BlurRadius="24" ShadowDepth="8" Opacity="0.08" />
                        </Border.Effect>
                        <StackPanel>
                            <TextBlock Text="Buscar o escanear" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource NeutralDarkBrush}" />
                            <TextBlock Text="Agrega artículos con el código o nombre" Style="{StaticResource CaptionStyle}" />
                            <TextBox x:Name="SearchTextBox" Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource PosTextBoxStyle}" Margin="0,12,0,0" />

                            <Border Visibility="{Binding HasSuggestions, Converter={StaticResource BooleanToVisibilityConverter}}"
                                    BorderBrush="{StaticResource SeparatorBrush}"
                                    BorderThickness="1"
                                    CornerRadius="14"
                                    Background="#FFFFFF"
                                    Margin="0,10,0,0">
                                <ListBox ItemsSource="{Binding ProductSuggestions}"
                                         MaxHeight="240"
                                         BorderThickness="0"
                                         ItemContainerStyle="{StaticResource SuggestionListBoxItemStyle}"
                                         ScrollViewer.VerticalScrollBarVisibility="Auto">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Margin="12,8">
                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Foreground="{StaticResource NeutralDarkBrush}" />
                                                <TextBlock Text="{Binding Barcode, StringFormat='Código: {0}'}" Style="{StaticResource SuggestionSecondaryTextStyle}" />
                                                <TextBlock Text="{Binding InternalCode, StringFormat='Clave interna: {0}'}" Style="{StaticResource SuggestionSecondaryTextStyle}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </Border>

                            <Grid Margin="0,18,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Button Content="Agregar"
                                        Command="{Binding AddProductCommand}"
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Height="44"
                                        MinWidth="160" />
                                <Button Grid.Column="1"
                                        Content="Vaciar"
                                        Command="{Binding ClearCartCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Height="44"
                                        MinWidth="140"
                                        Margin="16,0,0,0" />
                            </Grid>

                            <ProgressBar Style="{StaticResource InlineProgressBar}"
                                         Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
                                         Margin="0,18,0,0" />
                        </StackPanel>
                    </Border>

                    <Border CornerRadius="26"
                            Background="#FFFFFF"
                            Padding="26"
                            Margin="0,0,0,20"
                            Visibility="{Binding HasServices, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Border.Effect>
                            <DropShadowEffect Color="#1A1C33" BlurRadius="24" ShadowDepth="8" Opacity="0.08" />
                        </Border.Effect>
                        <StackPanel>
                            <TextBlock Text="Servicios rápidos"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource NeutralDarkBrush}" />
                            <TextBlock Text="Agrega consultas, curaciones u otros servicios sin afectar inventario."
                                       Style="{StaticResource CaptionStyle}"
                                       Margin="0,6,0,18" />

                            <ItemsControl ItemsSource="{Binding ServiceCatalog}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type models:ServiceCatalogItemModel}">
                                        <Border BorderBrush="{StaticResource SeparatorBrush}"
                                                BorderThickness="1"
                                                CornerRadius="18"
                                                Padding="16"
                                                Margin="0,0,0,12"
                                                Background="#F9FAFB">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="2*" />
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>
                                                <StackPanel>
                                                    <TextBlock Text="{Binding Name}"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource NeutralDarkBrush}" />
                                                    <TextBlock Text="{Binding DefaultPrice, StringFormat='Tarifa sugerida {0:C}'}"
                                                               Style="{StaticResource CaptionStyle}"
                                                               Margin="0,4,0,0" />
                                                </StackPanel>
                                                <StackPanel Grid.Column="1"
                                                            Margin="18,0,0,0">
                                                    <TextBlock Text="Importe"
                                                               Style="{StaticResource CaptionStyle}" />
                                                    <TextBox Text="{Binding ChargeAmount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                             Width="90"
                                                             Margin="0,4,0,0"
                                                             Style="{StaticResource PosTextBoxStyle}" />
                                                </StackPanel>
                                                <Button Grid.Column="2"
                                                        Content="Agregar"
                                                        Command="{Binding DataContext.AddServiceCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                                                        CommandParameter="{Binding}"
                                                        Style="{StaticResource PrimaryButtonStyle}"
                                                        Height="36"
                                                        Margin="20,18,0,0"
                                                        MinWidth="110" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <TextBlock Text="El material se captura aparte como productos del inventario."
                                       Style="{StaticResource CaptionStyle}"
                                       Margin="0,4,0,0"
                                       Foreground="#475569" />
                        </StackPanel>
                    </Border>

                    <Border CornerRadius="26" Background="#FFFFFF" Padding="26">
                        <Border.Effect>
                            <DropShadowEffect Color="#1A1C33" BlurRadius="24" ShadowDepth="8" Opacity="0.08" />
                        </Border.Effect>
                        <StackPanel>
                            <TextBlock Text="Método de pago" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource NeutralDarkBrush}" />
                            <TextBlock Text="Distribuye montos por forma de pago" Style="{StaticResource CaptionStyle}" />
                            <ComboBox ItemsSource="{Binding PaymentMethods}" SelectedItem="{Binding SelectedPaymentMethod}" Margin="0,16,0,0" Style="{StaticResource PosComboBoxStyle}" />

                            <Grid Margin="0,20,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="1*" />
                                    <ColumnDefinition Width="1*" />
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Efectivo" Style="{StaticResource PosLabelStyle}" />
                                    <TextBox Text="{Binding CashAmount, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource PosTextBoxStyle}" />
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="16,0,0,0">
                                    <TextBlock Text="Tarjeta" Style="{StaticResource PosLabelStyle}" />
                                    <TextBox Text="{Binding CardAmount, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource PosTextBoxStyle}" />
                                </StackPanel>
                            </Grid>

                            <Button Content="Cobrar" Command="{Binding CheckoutCommand}" Style="{StaticResource PrimaryButtonStyle}" Height="48" Margin="0,22,0,0" />
                        </StackPanel>
                    </Border>
                </StackPanel>

                <Border Grid.Column="1" CornerRadius="26" Background="#FFFFFF" Padding="26">
                    <Border.Effect>
                        <DropShadowEffect Color="#1A1C33" BlurRadius="24" ShadowDepth="8" Opacity="0.08" />
                    </Border.Effect>
                    <StackPanel>
                        <TextBlock Text="Resumen" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource NeutralDarkBrush}" />
                        <TextBlock Text="Detalle de montos de la operación" Style="{StaticResource CaptionStyle}" />
                        <StackPanel Margin="0,18,0,0">
                            <Grid Margin="0,4,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Subtotal" Style="{StaticResource PosLabelStyle}" Margin="0" />
                                <TextBlock Grid.Column="1" Text="{Binding Subtotal, StringFormat=C}" FontWeight="SemiBold" />
                            </Grid>
                        </StackPanel>
                        <Separator Margin="0,20,0,16" />
                        <StackPanel>
                            <TextBlock Text="Total a pagar"
                                       FontSize="20"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource NeutralDarkBrush}" />
                            <TextBlock Text="{Binding Total, StringFormat=C}"
                                       FontSize="32"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource PosAccentBrush}"
                                       Margin="0,4,0,0" />
                            <Border Background="#ECFDF5"
                                    CornerRadius="16"
                                    Padding="14,10"
                                    Margin="0,16,0,0"
                                    BorderBrush="#A7F3D0"
                                    BorderThickness="1">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SelectedPaymentMethod}" Value="{x:Static enums:PaymentMethod.Efectivo}">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding SelectedPaymentMethod}" Value="{x:Static enums:PaymentMethod.Mixto}">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding CashAmount}" Value="0">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Total}" Value="0">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Cambio"
                                               FontSize="18"
                                               FontWeight="SemiBold"
                                               Foreground="{StaticResource PosSuccessBrush}" />
                                    <TextBlock Text="{Binding ChangeAmount, StringFormat=' {0:C}'}"
                                               FontSize="24"
                                               FontWeight="Bold"
                                               Foreground="{StaticResource PosSuccessBrush}"
                                               Margin="12,0,0,0" />
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>

            <Border Grid.Row="3" CornerRadius="30" Background="#FFFFFF" Padding="0" Margin="0,18,0,0">
                <Border.Effect>
                    <DropShadowEffect Color="#1A1C33" BlurRadius="26" ShadowDepth="10" Opacity="0.08" />
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Border Background="{StaticResource PosCartHeaderBrush}" CornerRadius="30,30,0,0" Padding="22,16">
                        <DockPanel>
                            <StackPanel DockPanel.Dock="Left">
                                <TextBlock Text="Carrito" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource NeutralDarkBrush}" />
                                <TextBlock Text="{Binding CartItems.Count, StringFormat='{}{0} artículos'}" Style="{StaticResource CaptionStyle}" />
                            </StackPanel>
                            <TextBlock Text="{Binding Total, StringFormat='Total: {0:C}'}" FontWeight="SemiBold" Foreground="{StaticResource PosAccentBrush}" HorizontalAlignment="Right" VerticalAlignment="Center" />
                        </DockPanel>
                    </Border>

                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding CartItems}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              IsReadOnly="True"
                              Margin="16"
                              Style="{StaticResource CardDataGridStyle}"
                              ColumnHeaderStyle="{StaticResource PosDataGridHeaderStyle}"
                              RowStyle="{StaticResource PosCartDataGridRowStyle}"
                              BorderThickness="0"
                              GridLinesVisibility="None">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Producto" Binding="{Binding ProductName}" Width="2*" />
                            <DataGridTextColumn Header="Cantidad" Binding="{Binding Quantity}" Width="90" />
                            <DataGridTextColumn Header="Precio" Binding="{Binding UnitPrice, StringFormat=C}" Width="110" />
                            <DataGridTextColumn Header="Descuento" Binding="{Binding Discount}" Width="100" />
                            <DataGridTextColumn Header="Total línea" Binding="{Binding LineTotal, StringFormat=C}" Width="120" />
                            <DataGridTemplateColumn Header="" Width="60">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="✕" Style="{StaticResource DangerButtonStyle}" Padding="8,4" Command="{Binding DataContext.RemoveItemCommand, RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}" CommandParameter="{Binding}" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>

            <Border Grid.Row="4" Background="#FFFFFF" CornerRadius="18" Padding="18,14" Margin="0,18,0,0">
                <Border.Effect>
                    <DropShadowEffect Color="#1A1C33" BlurRadius="20" ShadowDepth="6" Opacity="0.05" />
                </Border.Effect>
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Visible" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding StatusMessage}" Value="">
                                <Setter Property="Visibility" Value="Collapsed" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding StatusMessage}" Value="{x:Null}">
                                <Setter Property="Visibility" Value="Collapsed" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <TextBlock Text="{Binding StatusMessage}" Foreground="#475569" />
            </Border>
        </Grid>
    </ScrollViewer>
</UserControl>
